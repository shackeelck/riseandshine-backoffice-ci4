import{_ as Q,s as O,r as p,c as R,M as Y,o as z,a as H,w as U,b as J,d as P,u as K,e as W,f as l,g as t,k as u,l as w,j as b,t as o,i as X,F as M,m as B,h as y,v as f,q as Z}from"./index-CfG8UM58.js";import{d as tt}from"./index-BSTMtCd0.js";import"./_commonjsHelpers-DsqdWQfm.js";const et={class:"p-6 max-w-6xl mx-auto"},st={class:"flex items-start justify-between gap-4 mb-6"},at={key:0,class:"text-sm text-gray-500"},ot={class:"font-medium"},nt={class:"font-medium"},lt={class:"font-medium"},ut={class:"flex gap-2"},dt=["disabled"],it={key:0,class:"text-red-600 mb-4"},rt={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},mt={class:"lg:col-span-2 space-y-6"},pt={class:"bg-white border rounded-lg p-4"},ct={class:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"},vt={class:"font-medium"},bt={class:"font-medium"},yt={class:"font-medium"},_t={class:"font-medium"},ft={class:"font-medium"},gt={class:"font-medium"},xt={class:"bg-white border rounded-lg p-4"},kt={key:0,class:"divide-y"},ht={class:"font-medium"},Ct={key:0,class:"ml-2 text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700"},wt={class:"text-sm text-gray-500"},Nt={key:1,class:"text-sm text-gray-500"},St={class:"bg-white border rounded-lg p-4"},Pt={class:"flex items-center justify-between mb-3"},Vt={class:"text-sm text-gray-500"},Dt={class:"font-semibold"},Rt={key:0,class:"overflow-auto"},Ut={class:"w-full text-sm border-collapse"},Mt={class:"px-3 py-2"},Bt={class:"font-medium"},jt={key:0,class:"text-xs text-red-600 mt-1"},qt={key:1,class:"text-xs text-blue-600 mt-1"},Tt={class:"px-3 py-2 text-right"},Ft={class:"px-3 py-2 text-center"},It={class:"px-3 py-2 text-center"},Lt=["max","onUpdate:modelValue","onInput"],$t={class:"px-3 py-2 text-right font-semibold"},Gt={key:1,class:"text-sm text-gray-500"},At={class:"bg-white border rounded-lg p-4"},Et={class:"space-y-6"},Qt={class:"bg-white border rounded-lg p-4"},Ot={key:0,class:"text-sm space-y-2"},Yt={class:"flex justify-between"},zt={class:"font-medium"},Ht={class:"flex justify-between"},Jt={class:"font-medium"},Kt={class:"flex justify-between"},Wt={class:"font-semibold"},Xt={key:1,class:"text-sm text-gray-500"},Zt={__name:"Checkout",setup(te){const j=O(),q=K(),N=Number(j.params.id),d=p(null),S=p([]),i=p(null),m=p([]),g=p(new Set),v=p({}),k=p(""),h=p(!1),_=p(""),r=p({proforma_id:null,payment_status:"unpaid",paid_amount:0,payment_method:"",payment_ref:"",payment_date:""}),C=s=>Number(s||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),V=s=>{const e=Number(s.quantity||0);let n=Number(s.consumed||0);Number.isNaN(n)&&(n=0),n=Math.max(0,Math.min(e,n)),s.consumed=n,s.total=n*Number(s.unit_price||0)},D=s=>Math.max(0,Number(s.consumed||0))*Number(s.unit_price||0),T=R(()=>m.value.reduce((s,e)=>s+D(e),0)),F=R(()=>!!d.value),I=async()=>{_.value="";const s=await P.get(`frontdesk/checkout/${N}`);d.value=s.data.booking||null,S.value=s.data.guests||[],i.value=s.data.proforma||null,k.value=d.value?.checkout_remarks||"",i.value?.id?r.value={proforma_id:Number(i.value.id),payment_status:i.value.payment_status||"unpaid",paid_amount:Number(i.value.paid_amount||0),payment_method:i.value.payment_method||"",payment_ref:i.value.payment_ref||"",payment_date:i.value.payment_date?String(i.value.payment_date).slice(0,10):""}:r.value.proforma_id=null,m.value=(s.data.minibar_lines||[]).map(e=>{const n={id:Number(e.id),minibar_item_id:Number(e.minibar_item_id),item_name:e.item_name||"",quantity:Number(e.quantity||0),consumed:Number(e.consumed||0),unit_price:Number(e.unit_price||0),total:Number(e.total||0),status:e.status||"pending"};return V(n),n})},x=new Map,L=s=>{if(x.has(s))return x.get(s);const e=tt(async n=>{await G(n.lineId,n.consumed)},450);return x.set(s,e),e},$=s=>{if(V(s),v.value[s.id]){const n={...v.value};delete n[s.id],v.value=n}L(s.id)({lineId:s.id,consumed:Number(s.consumed||0)})},G=async(s,e)=>{g.value=new Set([...g.value,s]);try{const a=(await P.post(`frontdesk/checkout/${N}/minibar/consume`,{line_id:s,consumed:Number(e||0)})).data?.line;if(a){const c=m.value.findIndex(E=>E.id===s);c!==-1&&(m.value[c].consumed=Number(a.consumed||m.value[c].consumed),m.value[c].total=Number(a.total||m.value[c].consumed*m.value[c].unit_price))}}catch(n){const a=n?.response?.data?.message||"Failed to save consumed qty";v.value={...v.value,[s]:a}}finally{const n=new Set(g.value);n.delete(s),g.value=n}},A=async()=>{_.value="",h.value=!0;try{const s={payment:r.value?.proforma_id?r.value:{},checkout_remarks:k.value},e=await P.post(`frontdesk/checkout/${N}`,s);e.data?.status==="success"?q.push("/bookings"):_.value=e.data?.message||"Checkout failed"}catch(s){_.value=s?.response?.data?.message||"Server error"}finally{h.value=!1}};return Y(()=>{for(const s of x.values())s&&typeof s.cancel=="function"&&s.cancel();x.clear()}),z(I),(s,e)=>{const n=W("router-link");return l(),H(J,null,{default:U(()=>[t("div",et,[t("div",st,[t("div",null,[e[9]||(e[9]=t("h2",{class:"text-xl font-semibold"},"Checkout",-1)),d.value?(l(),u("p",at,[e[6]||(e[6]=b(" Ref: ")),t("span",ot,o(d.value.reference),1),e[7]||(e[7]=b(" · Room: ")),t("span",nt,o(d.value.room_number||"-"),1),e[8]||(e[8]=b(" · Status: ")),t("span",lt,o(d.value.status),1)])):w("",!0)]),t("div",ut,[X(n,{to:"/bookings",class:"px-4 py-2 border rounded hover:bg-gray-50"},{default:U(()=>e[10]||(e[10]=[b(" Back ")])),_:1,__:[10]}),t("button",{onClick:A,class:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed",disabled:h.value||!F.value},o(h.value?"Saving...":"Complete Checkout"),9,dt)])]),_.value?(l(),u("p",it,o(_.value),1)):w("",!0),t("div",rt,[t("div",mt,[t("div",pt,[e[17]||(e[17]=t("h3",{class:"font-semibold mb-3"},"Booking Details",-1)),t("div",ct,[t("div",null,[e[11]||(e[11]=t("span",{class:"text-gray-500"},"Customer:",-1)),t("span",vt,o(d.value?.customer_name),1)]),t("div",null,[e[12]||(e[12]=t("span",{class:"text-gray-500"},"Room Type:",-1)),t("span",bt,o(d.value?.room_type),1)]),t("div",null,[e[13]||(e[13]=t("span",{class:"text-gray-500"},"Check-in:",-1)),t("span",yt,o(d.value?.check_in),1)]),t("div",null,[e[14]||(e[14]=t("span",{class:"text-gray-500"},"Check-out:",-1)),t("span",_t,o(d.value?.check_out),1)]),t("div",null,[e[15]||(e[15]=t("span",{class:"text-gray-500"},"Guests:",-1)),t("span",ft,o(d.value?.guests),1)]),t("div",null,[e[16]||(e[16]=t("span",{class:"text-gray-500"},"Flights:",-1)),t("span",gt,o(d.value?.arrival_flight||"-")+" / "+o(d.value?.departure_flight||"-"),1)])])]),t("div",xt,[e[18]||(e[18]=t("h3",{class:"font-semibold mb-3"},"Guests",-1)),S.value.length?(l(),u("div",kt,[(l(!0),u(M,null,B(S.value,a=>(l(),u("div",{key:a.id,class:"py-3 flex items-start justify-between gap-4"},[t("div",null,[t("div",ht,[b(o(a.name)+" ",1),String(a.is_primary)==="1"?(l(),u("span",Ct," Primary ")):w("",!0)]),t("div",wt," DOB: "+o(a.dob||"-")+" · ID: "+o(a.id_proof||"-"),1)])]))),128))])):(l(),u("div",Nt,"No guest data."))]),t("div",St,[t("div",Pt,[e[20]||(e[20]=t("h3",{class:"font-semibold"},"Minibar Consumption",-1)),t("div",Vt,[e[19]||(e[19]=b(" Total: ")),t("span",Dt,o(C(T.value)),1)])]),m.value.length?(l(),u("div",Rt,[t("table",Ut,[e[21]||(e[21]=t("thead",{class:"bg-gray-50 text-gray-700"},[t("tr",{class:"border-b"},[t("th",{class:"text-left px-3 py-2"},"Item"),t("th",{class:"text-right px-3 py-2"},"Price"),t("th",{class:"text-center px-3 py-2"},"Loaded Qty"),t("th",{class:"text-center px-3 py-2"},"Consumed Qty"),t("th",{class:"text-right px-3 py-2"},"Price for Consumed")])],-1)),t("tbody",null,[(l(!0),u(M,null,B(m.value,a=>(l(),u("tr",{key:a.id,class:"border-b hover:bg-gray-50"},[t("td",Mt,[t("div",Bt,o(a.item_name||"-"),1),v.value[a.id]?(l(),u("div",jt,o(v.value[a.id]),1)):g.value.has(a.id)?(l(),u("div",qt," Saving... ")):w("",!0)]),t("td",Tt,o(C(a.unit_price)),1),t("td",Ft,o(a.quantity),1),t("td",It,[y(t("input",{class:"input text-center",type:"number",min:"0",max:a.quantity,"onUpdate:modelValue":c=>a.consumed=c,onInput:c=>$(a)},null,40,Lt),[[f,a.consumed,void 0,{number:!0}]])]),t("td",$t,o(C(D(a))),1)]))),128))])])])):(l(),u("div",Gt," No minibar lines assigned for this booking. "))]),t("div",At,[e[22]||(e[22]=t("h3",{class:"font-semibold mb-2"},"Checkout Remarks",-1)),y(t("textarea",{"onUpdate:modelValue":e[0]||(e[0]=a=>k.value=a),rows:"3",class:"input"},null,512),[[f,k.value]])])]),t("div",Et,[t("div",Qt,[e[34]||(e[34]=t("h3",{class:"font-semibold mb-3"},"Invoice / Proforma",-1)),i.value?(l(),u("div",Ot,[t("div",Yt,[e[23]||(e[23]=t("span",{class:"text-gray-500"},"Proforma No",-1)),t("span",zt,o(i.value.invoice_no||i.value.id),1)]),t("div",Ht,[e[24]||(e[24]=t("span",{class:"text-gray-500"},"Currency",-1)),t("span",Jt,o(i.value.currency||"-"),1)]),t("div",Kt,[e[25]||(e[25]=t("span",{class:"text-gray-500"},"Amount",-1)),t("span",Wt,o(C(i.value.total_amount||0)),1)]),e[32]||(e[32]=t("hr",{class:"my-3"},null,-1)),t("div",null,[e[27]||(e[27]=t("label",{class:"label"},"Payment Status",-1)),y(t("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>r.value.payment_status=a),class:"input"},e[26]||(e[26]=[t("option",{value:"unpaid"},"Unpaid",-1),t("option",{value:"partial"},"Partial",-1),t("option",{value:"paid"},"Paid",-1)]),512),[[Z,r.value.payment_status]])]),t("div",null,[e[28]||(e[28]=t("label",{class:"label"},"Paid Amount",-1)),y(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>r.value.paid_amount=a),type:"number",step:"0.01",min:"0",class:"input"},null,512),[[f,r.value.paid_amount,void 0,{number:!0}]])]),t("div",null,[e[29]||(e[29]=t("label",{class:"label"},"Payment Method",-1)),y(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>r.value.payment_method=a),class:"input",placeholder:"Cash / Card / Bank..."},null,512),[[f,r.value.payment_method]])]),t("div",null,[e[30]||(e[30]=t("label",{class:"label"},"Payment Ref",-1)),y(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>r.value.payment_ref=a),class:"input",placeholder:"Receipt / Txn ID..."},null,512),[[f,r.value.payment_ref]])]),t("div",null,[e[31]||(e[31]=t("label",{class:"label"},"Payment Date",-1)),y(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>r.value.payment_date=a),type:"date",class:"input"},null,512),[[f,r.value.payment_date]])])])):(l(),u("div",Xt,e[33]||(e[33]=[b(" No proforma linked to this booking. "),t("div",{class:"mt-2"},"You can still checkout, but payment won’t be updated.",-1)])))]),e[35]||(e[35]=t("div",{class:"bg-white border rounded-lg p-4"},[t("h3",{class:"font-semibold mb-2"},"Ready to Checkout?"),t("ul",{class:"text-sm text-gray-600 list-disc ml-5 space-y-1"},[t("li",null,"Room must be assigned and confirmed."),t("li",null,"Update payment status and minibar charges."),t("li",null,"Click “Complete Checkout” to mark checked-out.")])],-1))])])])]),_:1})}}},oe=Q(Zt,[["__scopeId","data-v-32afa2b5"]]);export{oe as default};
